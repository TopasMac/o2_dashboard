{% extends 'reports_v2/_base.html.twig' %}

{# --------------------------------------------------------------------------
  Unit Purchase List – PDF
--------------------------------------------------------------------------- #}

{% block pdf_title %}
  {{ 'unit_purchase_list.title'|trans({}, 'unit_report') }}
{% endblock %}

{% block pdf_head_extra %}
  <style>
    /* Hide the standard footer (Owners2 contact line) for this report */
    .pdf-footer { display: none !important; }

    /* ===== Summary card (mirrors unit_report.pdf.twig; avoids CSS vars for wkhtmltopdf) ===== */
    .summary-card {
      position: relative;
      border: 1px solid #d1d5db;
      border-radius: 3pt;
      padding: 14px 12px 10px 12px;
      background: #fff;
      font-size: 8.5pt;
    }
    .summary-card .card-title {
      position: absolute;
      top: -9px;
      left: 10px;
      padding: 0 8px;
      background: #fff;
      color: #1E7668;
      font-weight: 700;
      font-size: 8.5pt;
    }
    .summary-card .summary-table { width: 100%; border-collapse: collapse; font-size: 8.5pt; }
    .summary-card .summary-table td { padding: 4.5pt 6pt; }
    .summary-card .summary-table tr:nth-child(odd) td { background: #f9fafb; }
    .summary-card .summary-table .label { color: #6b7280; font-weight: 700; width: 55%; }
    .summary-card .summary-table .value { text-align: right; white-space: nowrap; }

    /* ===== Category cards (one per category) ===== */
    .items-card {
      border: none;
      border-radius: 3pt;
      position: relative;
      padding: 10pt 8pt 8pt 8pt;
      margin-top: 10pt;
      background: #fff;
    }
    .items-card::before {
      content: "";
      position: absolute;
      top: 0; bottom: 0;
      left: 0; right: 0;
      border: 1px solid #d1d5db;
      border-radius: 3pt;
      pointer-events: none;
      background: transparent;
    }
    .items-card .card-title {
      position: absolute;
      top: -9px;
      left: 10px;
      padding: 0 8px;
      background: #fff;
      color: #1E7668;
      font-weight: 700;
      font-size: 9pt;
    }

    .items-card .mini-table { width: 100%; border-collapse: collapse; table-layout: fixed; }

    .items-card .mini-table th {
      padding: 0.5pt 4pt 1.5pt 4pt; /* tight top */
      vertical-align: top;
      font-size: 9pt;
      font-weight: 700;
    }
    .items-card .mini-table td {
      padding: 1.5pt 4pt;
      vertical-align: top;
      font-size: 9pt;
    }
    .items-card .mini-table .num { text-align: right; white-space: nowrap; }

    /* No inner row separators */
    .items-card .mini-table thead th { border-bottom: none; }
    .items-card .mini-table tbody td { border-bottom: none; }

    /* Item + notes typography */
    .items-card .item-name {
      font-size: 9pt;
      font-weight: 400;
      color: #111827;
      line-height: 1.25;
    }
    .items-card .item-note {
      font-size: 8pt;
      color: #6b7280;
      line-height: 1.2;
    }
  </style>
{% endblock %}

{% block pdf_content %}
  <div class="page">

    {# ===== META / SUMMARY ===== #}
    <table class="grid-2 mb-3">
      <tr>
        <td class="grid-2__col" style="padding-right:8pt; width:25%;">
          <div class="summary-card">
            <div class="card-title">Summary</div>
            <table class="summary-table">
              <tr>
                <td class="label">Unit:</td>
                <td class="value"><b>{{ unit.name }}</b></td>
              </tr>
              <tr>
                <td class="label">Type:</td>
                <td class="value">{{ unit.type is not empty ? unit.type : '—' }}</td>
              </tr>
              <tr>
                <td class="label">Pax:</td>
                <td class="value">{{ unit.pax is not null ? unit.pax : '—' }}</td>
              </tr>
              <tr>
                <td class="label">Beds:</td>
                <td class="value">{{ unit.beds is not null ? unit.beds : '—' }}</td>
              </tr>
              <tr>
                <td class="label">Baths:</td>
                <td class="value">{{ unit.baths is not null ? unit.baths : '—' }}</td>
              </tr>
            </table>
          </div>
        </td>

        <td class="grid-2__col" style="padding-left:8pt;">
          {# Right meta block (simple, no special styling) #}
          <div style="padding-top:2pt;">
            <h2 style="margin:0 0 6pt 0; color:#1E7668;">{{ 'unit_purchase_list.title'|trans({}, 'unit_report') }}</h2>
            <table class="summary-table">
              <tr>
                <td class="label">{{ 'unit_purchase_list.status'|trans({}, 'unit_report') }}</td>
                <td class="value"><b>{{ list.status|upper }}</b></td>
              </tr>
              {% if list.listReference %}
                <tr>
                  <td class="label">{{ 'unit_purchase_list.reference'|trans({}, 'unit_report') }}</td>
                  <td class="value"><b>{{ list.listReference }}</b></td>
                </tr>
              {% endif %}
            </table>
          </div>
        </td>
      </tr>
    </table>

    {# ===== ITEMS (one card per category) ===== #}
    {% set currentCategory = null %}
    {% set cardOpen = false %}

    {% for line in lines %}
      {# Robust category extraction #}
      {% set rawCategory = attribute(line, 'category') is not null ? attribute(line, 'category') : (attribute(line, 'category_name') is not null ? attribute(line, 'category_name') : (attribute(line, 'Category') is not null ? attribute(line, 'Category') : null)) %}
      {% set lineCategory = rawCategory is not null ? (rawCategory ~ '')|trim : 'Other' %}

      {% if lineCategory != currentCategory %}
        {# close previous category card #}
        {% if cardOpen %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        {% set currentCategory = lineCategory %}
        {% set cardOpen = true %}

        <div class="items-card">
          <div class="card-title">{{ currentCategory }}</div>
          <div style="padding-top:2pt;">
            <table class="mini-table">
              <thead>
                <tr>
                  <th style="width:26%; text-align:left;"></th>
                  <th style="width:20%; text-align:left;">Notes</th>
                  <th class="num" style="width:10%;">Minimum</th>
                  <th class="num" style="width:10%;">Existing</th>
                  <th class="num" style="width:10%;">Buy</th>
                  <th class="num" style="width:12%;">Price</th>
                  <th class="num" style="width:12%;">Total</th>
                </tr>
              </thead>
              <tbody>
      {% endif %}

      {% set muted = (line.neededQty is defined and line.neededQty == 0) %}
      <tr class="item-row"{% if muted %} style="color:#9ca3af;"{% endif %}>
        <td>
          <div class="item-name">{{ line.description }}</div>
        </td>
        <td>
          {% if line.notes %}
            <div class="item-note">{{ line.notes }}</div>
          {% endif %}
        </td>
        <td class="num">{{ line.targetQty is defined ? line.targetQty : (line.qty is defined ? line.qty : '—') }}</td>
        <td class="num">{{ line.existingQty is defined ? line.existingQty : '—' }}</td>
        <td class="num"><b>{{ line.neededQty is defined ? line.neededQty : '—' }}</b></td>
        <td class="num">{{ line.unitSellPrice is defined ? line.unitSellPrice : '—' }}</td>
        <td class="num"><b>{{ line.lineTotalSellPrice is defined ? line.lineTotalSellPrice : '—' }}</b></td>
      </tr>
    {% endfor %}

    {# close final category card #}
    {% if cardOpen %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

  </div>
{% endblock %}